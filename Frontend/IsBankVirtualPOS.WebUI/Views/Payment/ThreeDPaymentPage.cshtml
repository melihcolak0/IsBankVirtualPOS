@model ThreeDPaymentFormDTO

@{
    Layout = null;
    ViewData["Title"] = "3D Secure Doğrulama";
    string paymentId = Model.PaymentId.ToString();
    string mdStatus = Model.MdStatus;
    string responseCode = Model.ResponseCode;
    string authCode = Model.AuthCode;
    string bankRefNo = Model.BankReferenceNumber;
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Secure Doğrulama - İşBank Sanal POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navbar */
        .navbar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .navbar-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .navbar-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

            .navbar-title span {
                color: #3b82f6;
            }

        .secure-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #15803d;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 20px;
            padding: 5px 12px;
        }

        /* Adım Çubuğu */
        .steps-bar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 32px;
        }

        .steps {
            display: flex;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
            padding: 16px 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

            .step:not(:last-child)::after {
                content: '';
                flex: 1;
                height: 2px;
                background: #e2e8f0;
                margin: 0 8px;
            }

            .step.completed:not(:last-child)::after {
                background: #3b82f6;
            }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
            background: white;
            flex-shrink: 0;
        }

        .step.active .step-circle {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
        }

        .step.completed .step-circle {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .step-label {
            font-size: 12px;
            font-weight: 500;
            color: #94a3b8;
            white-space: nowrap;
        }

        .step.active .step-label {
            color: #3b82f6;
            font-weight: 600;
        }

        .step.completed .step-label {
            color: #3b82f6;
        }

        /* İçerik */
        .page-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }

        .verify-wrapper {
            max-width: 440px;
            width: 100%;
        }

        /* 3D Secure banka kutusu */
        .bank-header {
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
            border-radius: 12px 12px 0 0;
            padding: 20px 28px;
            display: flex;
            align-items: center;
            gap: 14px;
            color: white;
        }

        .bank-logo {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .bank-header-text .bank-name {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .bank-header-text .bank-sub {
            font-size: 12px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .verified-logo {
            margin-left: auto;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.3px;
            text-align: center;
            line-height: 1.3;
        }

        /* Ana kart */
        .verify-card {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            border-top: none;
            overflow: hidden;
        }

        /* İşlem özeti şeridi */
        .transaction-strip {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .transaction-strip .t-label {
                font-size: 12px;
                color: #94a3b8;
                font-weight: 500;
            }

            .transaction-strip .t-value {
                font-size: 15px;
                font-weight: 800;
                color: #1e293b;
            }

            .transaction-strip .t-id {
                font-size: 11px;
                color: #94a3b8;
                margin-top: 2px;
            }

        .verify-body {
            padding: 28px 28px 24px;
        }

        /* Kilitli ikon + başlık */
        .verify-icon-wrap {
            text-align: center;
            margin-bottom: 22px;
        }

        .shield-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            border: 2px solid #bfdbfe;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            margin-bottom: 12px;
            animation: pulseShield 2s ease-in-out infinite;
        }

        .verify-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .verify-sub {
            font-size: 13px;
            color: #64748b;
            line-height: 1.5;
        }

        /* E-posta göstergesi (sadece tasarım) */
        .email-display {
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .email-display .email-icon {
                font-size: 18px;
                flex-shrink: 0;
            }

            .email-display .email-text .label {
                font-size: 11px;
                color: #94a3b8;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.4px;
                margin-bottom: 2px;
            }

            .email-display .email-text .value {
                font-size: 14px;
                font-weight: 600;
                color: #1e293b;
            }

            .email-display .change-link {
                margin-left: auto;
                font-size: 12px;
                color: #3b82f6;
                text-decoration: none;
                font-weight: 600;
                white-space: nowrap;
            }

        /* OTP input grubu */
        .otp-label {
            font-size: 12px;
            font-weight: 700;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: block;
        }

        .otp-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 8px;
        }

        .otp-input {
            width: 52px;
            height: 58px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            background: white;
            transition: all 0.15s;
            caret-color: #3b82f6;
        }

            .otp-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
                background: #eff6ff;
            }

            .otp-input.filled {
                border-color: #3b82f6;
                background: #eff6ff;
            }

        .otp-hint {
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        /* Geri sayım */
        .countdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 14px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .countdown-text {
            font-size: 13px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .countdown-timer {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            font-variant-numeric: tabular-nums;
        }

            .countdown-timer.expiring {
                color: #dc2626;
            }

        .resend-btn {
            font-size: 13px;
            font-weight: 600;
            color: #3b82f6;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            text-decoration: none;
            opacity: 0.4;
            pointer-events: none;
            transition: opacity 0.2s;
        }

            .resend-btn.active {
                opacity: 1;
                pointer-events: all;
            }

                .resend-btn.active:hover {
                    text-decoration: underline;
                }

        /* Submit */
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

            .submit-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 8px 24px rgba(59,130,246,0.35);
            }

            .submit-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .submit-btn:active:not(:disabled) {
                transform: translateY(0);
            }

        /* Güvenli işlem notu */
        .secure-footer-note {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 16px;
            font-size: 12px;
            color: #94a3b8;
        }

        /* Page footer */
        .page-footer {
            text-align: center;
            padding: 18px;
            font-size: 12px;
            color: #94a3b8;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

            .page-footer a {
                color: #3b82f6;
                text-decoration: none;
            }

        @@keyframes pulseShield {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59,130,246,0.2);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(59,130,246,0);
            }
        }

        body {
            animation: fadeIn 0.4s ease;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@media (max-width: 640px) {
            .navbar {
                padding: 0 16px;
            }

            .steps-bar {
                padding: 0 16px;
            }

            .step-label {
                display: none;
            }

            .page-content {
                padding: 20px 12px;
            }

            .verify-body {
                padding: 22px 18px 20px;
            }

            .bank-header {
                padding: 16px 20px;
            }

            .transaction-strip {
                padding: 12px 18px;
            }

            .otp-input {
                width: 44px;
                height: 52px;
                font-size: 20px;
            }

            .otp-inputs {
                gap: 8px;
            }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="#" class="navbar-brand">
            <div class="navbar-logo">🏦</div>
            <div class="navbar-title">İşBank <span>Sanal POS</span></div>
        </a>
        <div class="secure-badge">🔒 Güvenli Bağlantı</div>
    </nav>

    <!-- Adım Çubuğu -->
    <div class="steps-bar">
        <div class="steps">
            <div class="step completed">
                <div class="step-circle">✓</div>
                <span class="step-label">Tutar</span>
            </div>
            <div class="step completed">
                <div class="step-circle">✓</div>
                <span class="step-label">Kart Bilgileri</span>
            </div>
            <div class="step active">
                <div class="step-circle">3</div>
                <span class="step-label">3D Doğrulama</span>
            </div>
        </div>
    </div>

    <!-- İçerik -->
    <div class="page-content">
        <div class="verify-wrapper">

            <!-- Banka başlığı -->
            <div class="bank-header">
                <div class="bank-logo">🏦</div>
                <div class="bank-header-text">
                    <div class="bank-name">İşBank Güvenli Ödeme</div>
                    <div class="bank-sub">🔒 3D Secure Doğrulama</div>
                </div>
                <div class="verified-logo">Verified<br />by Visa</div>
            </div>

            <div class="verify-card">

                <!-- İşlem özeti -->
                <div class="transaction-strip">
                    <div>
                        <div class="t-label">Ödenecek Tutar</div>
                        <div class="t-value">₺@Model.Amount.ToString("N2")</div>
                    </div>
                    <div style="text-align:right">
                        <div class="t-label">İşlem Referansı</div>
                        <div class="t-id">@paymentId.ToString().Substring(0, 8).ToUpper()…</div>
                    </div>
                </div>

                <div class="verify-body">

                    <!-- Kalkan ikonu -->
                    <div class="verify-icon-wrap">
                        <div class="shield-icon">🛡️</div>
                        <div class="verify-title">Kimliğinizi Doğrulayın</div>
                        <div class="verify-sub">
                            Ödemenizi onaylamak için telefon numaranıza<br />
                            gönderilen 6 haneli kodu giriniz.
                        </div>
                    </div>

                    <!-- E-posta göstergesi (tasarım amaçlı) -->
                    <div class="email-display">
                        <span class="email-icon">📧</span>
                        <div class="email-text">
                            <div class="label">Kod Gönderildi</div>
                            <div class="value">k***@@gmail.com</div>
                        </div>
                        <a href="#" class="change-link">Değiştir</a>
                    </div>

                    <!-- OTP Form -->
                    <form id="otpForm" onsubmit="return verifyOtp(event)">
                        <input type="hidden" name="PaymentId" value="@paymentId" />
                        <input type="hidden" name="MdStatus" value="@mdStatus" />
                        <input type="hidden" name="ResponseCode" value="@responseCode" />
                        <input type="hidden" name="AuthCode" value="@authCode" />
                        <input type="hidden" name="BankReferenceNumber" value="@bankRefNo" />
                        <input type="hidden" name="OtpCode" id="otpHidden" />

                        <span class="otp-label">Doğrulama Kodu</span>

                        <div class="otp-inputs">
                            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" />
                            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" />
                            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" />
                            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" />
                            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" />
                            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" />
                        </div>
                        <div class="otp-hint">Her kutuya bir rakam giriniz</div>

                        <!-- Geri sayım -->
                        <div class="countdown-row">
                            <span class="countdown-text">⏱ Kodun geçerlilik süresi:</span>
                            <div style="display:flex; align-items:center; gap:14px;">
                                <span class="countdown-timer" id="countdownTimer">02:00</span>
                                <button type="button" class="resend-btn" id="resendBtn" onclick="restartCountdown()">
                                    Tekrar Gönder
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" id="submitBtn" disabled>
                            🔐 &nbsp; Ödemeyi Onayla
                        </button>
                    </form>

                    <form method="POST"
                          action="https://localhost:7290/api/payments/3d-callback"
                          id="bankForm"
                          style="display:none">

                        <input type="hidden" name="PaymentId" value="@paymentId" />
                        <input type="hidden" name="MdStatus" value="@mdStatus" />
                        <input type="hidden" name="ResponseCode" value="@responseCode" />
                        <input type="hidden" name="AuthCode" value="@authCode" />
                        <input type="hidden" name="BankReferenceNumber" value="@bankRefNo" />

                    </form>

                    <div class="secure-footer-note">
                        🔒 &nbsp; Bu sayfa 256-bit SSL ile şifrelenmiştir
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
        © 2025 İşBank Sanal POS &nbsp;·&nbsp;
        <a href="#">Gizlilik Politikası</a> &nbsp;·&nbsp;
        <a href="#">Güvenlik</a>
        &nbsp;|&nbsp; 🔒 256-bit SSL &nbsp; 🛡️ 3D Secure &nbsp; ✅ PCI DSS
    </footer>

    <script>
        // ── OTP Kutu Mantığı ──────────────────────────────────────────
        const inputs  = document.querySelectorAll('.otp-input');
        const hidden  = document.getElementById('otpHidden');
        const submitBtn = document.getElementById('submitBtn');

        inputs.forEach((input, i) => {
            input.addEventListener('input', (e) => {
                // Sadece rakam
                input.value = input.value.replace(/\D/g, '').slice(-1);
                input.classList.toggle('filled', input.value !== '');

                // Sonraki kutuya geç
                if (input.value && i < inputs.length - 1) {
                    inputs[i + 1].focus();
                }

                syncOtp();
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !input.value && i > 0) {
                    inputs[i - 1].focus();
                    inputs[i - 1].value = '';
                    inputs[i - 1].classList.remove('filled');
                    syncOtp();
                }
            });

            // Yapıştırma desteği
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasted = (e.clipboardData.getData('text') || '').replace(/\D/g, '');
                [...pasted].slice(0, 6).forEach((char, idx) => {
                    if (inputs[idx]) {
                        inputs[idx].value = char;
                        inputs[idx].classList.add('filled');
                    }
                });
                const next = Math.min(pasted.length, 5);
                inputs[next].focus();
                syncOtp();
            });
        });

        function syncOtp() {
            const code = [...inputs].map(i => i.value).join('');
            hidden.value = code;
            submitBtn.disabled = code.length < 6;
        }

        // İlk kutuya otomatik odaklan
        inputs[0].focus();

        // ── Geri Sayım ───────────────────────────────────────────────
        let seconds = 120;
        let timer;
        const timerEl  = document.getElementById('countdownTimer');
        const resendBtn = document.getElementById('resendBtn');

        function tick() {
            seconds--;
            const m = String(Math.floor(seconds / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            timerEl.textContent = `${m}:${s}`;
            timerEl.classList.toggle('expiring', seconds <= 30);

            if (seconds <= 0) {
                clearInterval(timer);
                timerEl.textContent = '00:00';
                resendBtn.classList.add('active');
            }
        }

        function restartCountdown() {
            seconds = 120;
            timerEl.classList.remove('expiring');
            resendBtn.classList.remove('active');
            clearInterval(timer);
            timer = setInterval(tick, 1000);
            // Kod kutularını sıfırla
            inputs.forEach(i => { i.value = ''; i.classList.remove('filled'); });
            hidden.value = '';
            submitBtn.disabled = true;
            inputs[0].focus();
        }

        timer = setInterval(tick, 1000);

        // ── Otp Onayı ───────────────────────────────────────────
                async function verifyOtp(e) {

            e.preventDefault(); // form submiti durdur

            const otp = document.getElementById("otpHidden").value;
            const paymentId = "@paymentId";

            if (otp.length !== 6) {
                alert("Lütfen 6 haneli kodu giriniz");
                return false;
            }

            const submitBtn = document.getElementById("submitBtn");
            submitBtn.disabled = true;
            submitBtn.innerText = "Doğrulanıyor...";

            try {

                const response = await fetch(
                    "https://localhost:7290/api/payments/verify-otp",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            paymentId: paymentId,
                            otp: otp
                        })
                    });

                if (!response.ok) {
                    alert("Kod yanlış veya süresi dolmuş");
                    submitBtn.disabled = false;
                    submitBtn.innerText = "🔐  Ödemeyi Onayla";
                    return false;
                }

                // OTP DOĞRU → BANKAYA GİT
                document.getElementById("bankForm").submit();

            } catch {
                alert("Sunucu hatası oluştu");
                submitBtn.disabled = false;
                submitBtn.innerText = "🔐  Ödemeyi Onayla";
            }

            return false;
        }
    </script>

</body>
</html>
